# 8장. URL 단축기 설계

## 기본 가정
- URL 단축 : 주어진 긴 URL을 짧게 줄여야 한다.
- URL 리디렉션 : 축약된 URL로 HTTP 요청이 오면 원래 URL로 안내
- 높은 가용성과 규모 확정석, 장애 감내가 요구됨

## 개략적 설계안

### API 엔드포인트
- 클라이언트는 서버가 제공하는 API 엔드포인트를 통해 서버와 통신한다.
- REST 스타일로 설계
- URL 단축용 엔드포인트
  - POST /api/v1/data/shorten
  - 인자 : {longUrl : longURLString}
  - 반환 : 단축 URL
- URL 리디렉션용 엔드포인트
  - GET /api/v1/shortURL
  - 반환 : HTTP 리디렉션 목적지가 될 원래 URL

### URL 리디렉션
1. 단축 URL 전달 
2. 서버에서 원래 URL로 바꿈. 
3. 301 응답의 Location헤더로 넣어 반환
- 301 Permanently Moved 
  - HTTP 요청의 처리 책임이 영구적으로 Location 헤더로 반환된 URL로 이전.
  - 브라우저는 응답을 캐시한다.
  - 추후 같은 URL 요청을 보내면 브라우저가 캐시된 원래 URL로 보낸다.
  - 서버 부하를 줄일 수 있다.
- 302 Found
  - 일시적으로 Location 헤더가 지정되는 URL에 의해 처리됨.
  - 언제나 URL 서버에 먼저 보내진 후에 원래 URL로 리디렉션되어야 한다.
  - 데이터 분석시 유리하다.
- 가장 직관적인 구현 방법 -> 해시 테이블
### URL 단축
- 긴 URL을 해시 값으로 대응시킬 해시 함수 fx 필요
  - 긴 URL이 다른 값이면 해시 값도 달라야 한다. 
  - 원래 입력으로 주어졌던 긴 URL로 복원될 수 있어야 한다.

## 상세설계

### 데이터 모델
- 시스템 규모가 커지면 <단축 URL, 원래 URL>의 순서쌍으로 관계형 데이터베이스에 저장해야한다.

### 해시 함수
- 원래 URL을 단축 URL로 변화하는데 사용
- hashValue는 [0-9,a-z,A-Z] 문자로 구성(62개)
- hashValue 개수에 따라 만들 수 있는 URL 개수 결정
- 해시 함수 구현 방법
  - 해시 후 충돌 해소 기법
    - CRC32, MD5, SHA-1
    - 1. 해시 값의 처음 몇 자리만 사용
    - 2. 충돌이 발생하면 문자열에 해시값을 덧붙인다.
    - 데이터베이스 질의가 필요해 오버헤드가 크다.
    - 데이터베이스 대신 블룸 필터를 사용하면 성능을 높일 수 있다.
    - 단축 URL 길이가 고정됨
    - 유일성이 보장되는 ID 생성기가 피요하지 않음
    - 충돌이 가능해서 해소 전략이 필요
    - 다음에 쓸 수 있는 URL을 알아내는 것이 불가능
  - base-62 기법
    - 수의 표현 방식이 다른 두 시스템이 같은 수를 공유하여야 하는 경우에 유용하다.
    - 62진법으로 변환하는 것
    - hashValue가 62개 문자이기 떄문에 62진법 사용
    - 단축 URL의 길이가 가변적 - ID 값이 커지면 같이 길어진다.
    - 유일성 보장 ID생성기 필요
    - ID의 유일성이 보장된 후 적용 가능 전략이기 때문에 충돌 불가능
    - 단축 URL이 무엇인지 쉽게 알아낼 수 있어서 보안상 문제가 될 소지가 잇음

### URL 단축기 상세 설계
- base-62 기법 사용
1. 입력으로 긴 URL을 받는다.
2. 해당 URL이 데이터베이스에 있는지 검사한다.
3. 데이터 베이스에 있으면 해당 URL을 가져와 클라이언트에 반환한다.
4. 없는 경우에는 새로 접수된 것이므로 유일한 ID를 생성한다. ID는 데이터베이스 기본 키로 사용된다.
5. 62진법 변환을 적용, ID를 단축 URL로 만든다.
6. ID, 단축 URL, 원래 URL로 새 데이터베이스 레코드를 만든 후 단축 URL을 클라이언트에 전달한다.
- ID 생성기의 주된 용도는, 단축 URL을 만들 때 사용할 ID를 맏느는 것. 전역적 유일성이 보장되야 함.

### URL 리디렉션 상세 설계
- 쓰기보다 읽기를 더 자주하는 시스템이다.
- <단축 URL, 원래 URL>의 쌍을 캐시에 저장하여 성능을 높인다.
- 로드 밸런서 동작 흐름
  1. 사용자가 단축 URL을 클릭한다.
  2. 로드밸런서가 해당 클릭으로 발생한 요청을 웹 서버에 전달한다.
  3. 단축 URL이 캐시에 있는 경우 원래 URL을 꺼내 클라이언트에 전달
  4. 캐시에 없으면 데이터베이스에 꺼낸다. 데이터베이스에 없으면 사용자가 잘못된 단축 URL을 입력한 것
  5. 데이터베이스에서 꺼낸 URL을 캐시에 넣은 후 사용자에게 반환한다.

## 마무리
