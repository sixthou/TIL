# 11장. 뉴스 피드 시스템 설계
- 지속적으로 업데이트되는 페이지
- 페이스북 뉴스 피드, 인스타그램 뉴스 피드와 같다. 

## 개략적 설계안

### 피드 발행
- 포스팅 저장 서비스
  - 새 포스팅을 데이터베이스와 캐시에 저장
- 포시팅 전송 서비스
  - 친구의 뉴스 피드에 푸시한다.
  - 뉴스 피드 데이터는 캐시에 보관한다.
- 알림 서비스
  - 새 포스팅이 올라왔음을 알리거나, 푸시 알림을 보내는 역할을 한다

### 뉴스 피드 생성
- 뉴스 피드 서비스 
  - 캐시에서 뉴스 피드를 가져오는 서비스
- 뉴스 피드 캐시
  - 뉴스 피드를 렌더링할 떄 필요한 피드 ID를 보관한다.

## 피드 발생 흐름 상세 설계
- 웹 서버
  - 클라이언트 통신과 인증, 처리율 제한 수행
- 포스팅 전송 서비스(팬아웃)
  - 어떤 사용자의 새 포스팅을 친구 관계에 있는 사용자에게 전달하는 과정
- 쓰기 시점에 팬아웃 하는 모델
  - 포스팅이 완료되면 바로 해당 사용자의 캐시에 해당 포스팅을 기록하는 것
  - 장점
    - 실시간으로 갱신되며 친구 목록레 있는 사용자ㅏ에게 즉시 전송
    - 새 포스팅을 기록하는 순간에 뉴스 피드가 이미 갱신됨. 
    - 뉴스 피드를 읽는 데 드는 시간이 짦음
  - 단점
    - 친구가 만은 사용자들의 목록을 가져오고 갱신하는데 많은 시간이 소요될 수 있다. (핫키)
    - 서비스를 자주 이용하지 않는 사용자까지 갱신해야됨 -> 자원낭비
- 읽기 시점에 팬아웃하는 모델
  - 피드를 읽어야 하는 시점에 갱신한다 
  - 요청 기반 모델
  - 장점
    - 로그인하기전까지 어떤 자원도 소모하지 않는다.
    - 핫키 문제도 생기지 않는다.
  - 단점
    - 뉴스 피드를 읽는데 많은 시간이 소요될 수 있다.

- 팬아웃 서비스 동작 시퀀스
  1. 친구 ID 목록을 가져온다 
  2. 사용자 정보 캐시에서 친구들 정보를 가져오고, 친구 설정에 따라 필터링한다.
  3. 친구 목록과 새 스토리 포스팅 ID를 메시지 큐에 넣는다.
  4. 팬아웃 작업 서버가 메시지 큐에서 데이터를 꺼내어 뉴스 피드 데이터를 뉴스 피드 캐시에 넣는다.

- 피드 읽기 흐름 
  1. 사용자가 뉴스 피드를 읽는 요청을 보낸다.
  2. 로드밸런서가 요청을 웹 서버로 보낸다. 
  3. 웹 서버는 피드를 가져오기 위해 뉴스 피드 서비스를 호출한다.
  4. 뉴스 피드 서비스는 뉴스 피드 캐시에 포스팅 ID 목록을 가져온다.
  5. 뉴스 피드에 표시할 콘첸츠를 가져와 완전한 뉴스피드 생성
  6. 뉴스피드를 클라이언트에 보낸다. 클라이언트는 해당 피드를 렌더링한다.

