# 13장. 검색어 자동완성 시스템
- 검색어가 자동으로 완성되어 추천 표시되는 기능

## 설계 범위 확정
- 빠른 응답 속도 
- 연관성
- 정렬
- 규모 확장성
- 고가용성

## 주요 서비스
- 데이터 수집 서비스
  - 사용자가 입력한 질의를 실시간으로 수집하는 시스템

- 질의 서비스
  - 주어진 질의에 인기검색어를 정렬해 내놓는 서비스

## 상세설계
- 트라이 자료구조
    - 문자열을 간략하게 저장할 수 있는 자료구조
    - 트리 형태의 자료구조
    - 루트 노드는 빈 문자열을 나타낸다.
    - 각 노드는 글자 하나를 저장한다. 26개의 저식 노드를 가질 수 있다.(모든 글자 수)
    - 각 트리 노드는 하나의 단어, 또는 접두어 문자열을 나타낸다.
    - 트라이로 검색어 자동완성
      - p : 접두어 길이
      - n : 트라이 안에 있는 노드 개수
      - c : 주어진 노드의 자식 노드 개수
      - 해당 접두어를 표현하는 노드를 찾는다.
      - 해당 노드부터 시작하는 하위 트리를 탐색하여 모든 유효 노드를 찾는다.
      - 유효 노드들을 정렬하여 가장 인기 있는 검색어 k를 찾는다.
      - 최악의 경우 전체 트라이 검색해야 한다.
        - 접두어 최대 길이 제한
          - 시간 복잡도가 O(1)로 바뀐다
        - 각 노드의 인기 검색어를 캐시
          - 각 노드에 k개의 인기 검색어를 저장
          - 시간 복잡도가 O(1)로 바뀐다

- 데이터 수집 서비스
    - 데이터 분석 서비스 로그
      - 검색창에 입력된 질의에 관한 원본 데이터가 보관된다.
      - 새로운 데이터가 추가될 뿐 인덱스는 걸지 않는다.
    - 로그 취합 서버
    - 취합된 데이터
    - 작업 서버
      - 주기적으로 비동기적 작업을 실행하는 서버 집합
      - 트라이 자료구조를 만들고 트라이 데이터베이스 저장 역할을 담당한다.
    - 트라이 캐시
    - 트라이 데이터베이스
      - 지속성 저장소 
      - 문서 저장소 
        - 새 트라이를 매주 만들 것이므로, 주기적으로 트라이를 직렬화하여 데이터베이스에 저장할 수 있다.
        - 몽고디비 같은 문서 저장소
      - 키-값 저장소
        - 트라이에 보관된 모든 접두어를 해시테이블 키로 변환
        - 각 트라이 노드에 보관된 모든 데이터를 해시 테이블 값으로 변환


- 질의 서비스
  - 질의 서비스는 빨라야 한다.
  - 최적화 방안
    - AJAX 요청
    - 브라우저 캐싱
    - 데이터 샘플링

    
- 트라이 연산
    - 트라이 생성
      - 작업 서버가 담당하며, 데이터 분석 서비스의 로그나 데이터베이스로부터 취한된 데이터를 이용한다.
    - 트라이 갱신
      - 매주 한 번 갱신하는 방법 : 새로운 트라이를 만든 다음 기존 트라이를 대체한다.
      - 트라이의 각 노드를 개별적으로 갱신하는 방법
        - 트라이가 작을 때 고려해봄직
    - 검색어 삭제
      - 트라이 캐시 앞에 필터 계층을 두고 부적절한 질의어가 반환되지 않도록 해야한다.

- 저장소 규모 확장
