# 14장. 유튜브 설계

## 설계 범위 확정
- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라비용
- 높은 가용성과 규모 확장성, 그리고 안정성
- 지원 클라이언트 : 모바일 앱, 웹브라우저, 스마트 TV

## 개략적 설계안
- 세 개의 컴포넌트로 구성
- 단말 컴퓨터, 모바일 폰, 스마트 티비
- CDN : 비디오는 CDN에 저장, 재생 버튼을 누르면 CDN으로부터 스트리밍 됨
- API 서버 : 모든 요청은 API 서버가 처리한다.

- 비디오 업로드 절차 
  - 컴포넌트
    - 사용자 
    - 로드밸런서
    - API 서버
    - 메타데이터 데이터 베이스 : 비디오의 메타데이터를 보관한다. 샤딩과 다중화를 적용하여 성능 및 가용성 요구사항 충족한다.
    - 메타데이터 캐시 : 성능을 높이기 위해 비디오 메타데이터와 사용자 객체는 캐시한다.
    - 원본 저장소 : 원본 비디오를 보관한 대형 이진 파일 저장소
    - 트랜스코딩 서버 : 비디오 인코딩이라 부르는 절차, 비디오 포맷을 변환
    - 트랜스코딩 비디오 저장소 : 트랜스코딩이 완료된 비디오를 저장하는 이진 저장소
    - CDN
    - 트랜스코딩 완료 큐 : 비디오 트랜스 코딩 완료 이벤트들을 보관할 메시지 큐
    - 트랜스코딩 완료 핸들러 : 트랜스코딩 완료 큐에서 이벤트 데이터를 꺼내어 메타데이터 캐시와 데이터베이스 갱신할 작업 서버
  - 비디오 업로드 프로세스
    1. 비디오를 원본 저장소에 업로드
    2. 트랜스코딩 서버는 원본 저장소에서 원본을 가져와 트랜스코딩 시작
    3. 트랜스코딩이 완료되면 병렬 수행
        1. 완료된 비디오를 트랜스코딩 비디오 저장소에 업로드한다.
        2. 트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣는다.
           1. 트랜스코딩이 끝난 비디오를 CDN에 올린다.
           2. 완료 핸들러가 이벤트 데이터를 큐에서 꺼낸다.
           3. 완료 핸들러가 메타데이터데 데이터베이스와 캐시를 갱신한다.
    4. API 서버가 단말에게 비디오 업로드가 끝나 스트리밍 준비가 됐음을 알린다.
  - 메타데이터 갱신
    - 비디오가 업로드 되는 동안 병렬적으로 갱신 요청을 API 서버에 보낸다.
    - 파일 이름, 크기, 포멧등 정보가 들어 잇다.

- 비디오 스트리밍 절차
  - 스트리밍 프로토콜은 비디오 스트리밍을 위해 데이터를 전송할 떄 쓰이는 표준화된 통신방법
  - 비디오는 CDN에서 바로 스트리밍 된다.

## 상세설계
- 비디오 트랜스 코딩
  - 비디오를 다른 단말과 호환되는 포맷으로 저장
  - 저장 공간 확보
  - 다양한 포맷 지원
  - 대역폭에 맞는 비디오 전송
  - 컨테이너 : 메타데이터를 담는 바구니
  - 코덱 : 압축 및 압축 해제 알고리즘

- 유향 비순환 그래프(DAG)모델
  - 작업을 단계별로 배열할 수 있도록 하여 작업들이 순차적으로 or 병렬적으로 실행될 수 있도록 한다.
  - 검사
  - 비디오 인코딩
  - 섬네일
  - 워터마

- 비디오 트랜스코딩 아키텍쳐
  - 전처리기, DAG 스케줄러, 자원 관리자, 작업 실행 서버, 임시 저장소
  - 전처리기
    - 비디오 분할
      - 비디오 스트림을 GOP라 불리는 단위로 쪼갠다.
      - 하나의 GOP는 독리적으로 재생 가능, 몇 초 정도
    - DAG 생성
    - 데이터 캐시
  - DAG 스케줄러
    - DAG 그래프
      1. 비디오, 오디오, 메타데이터 분리
      2. 비디오 파일을 인코딩하고 섬네일 추출, 오디오 파일 인코딩
  - 자원 관리자
    - 자원 배분을 효과적으로 수행하는 역할
    - 작업 큐 : 실행할 작업이 보관되는 우선순위 큐
    - 작업 서버 큐 : 작업 서버의 가용 상태 정보가 보관
    - 실행 큐 : 형재 실행 중인 작업 및 작업 서버 정보 보관
    - 작업 스케쥴러 : 최적의 작업/서버 조합을 골라, 해당 작업 서버가 작업 수행하도록 지시
  - 작업 관리자
    - 작업 큐에서 우선순위 높은 작업을 꺼낸다.
    - 적합한 작업 서버를 고른다
    - 해당 작업 서버에게 작업 실행을 지시
  - 작업 서버
  - 인코딩 비디오

- 시스템 최적화
  - 속도 최적화
    - 비디오 병렬 업로드
    - 업로드 센터를 사용자 근거리에 지정
    - 모든 절차를 병렬화
  - 안정성 최적화
    - 미리 사인된 업로드 URL
    - 비디오 보호
  - 비용 최적화 

- 오류 처리
