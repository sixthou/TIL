# 1장. 사용자 수에 따른 규모 확장성
- 단일 서버 시스템으로 시작해서 사용자 규모에 맞춰 시스템을 개선하며 서비스를 확장해 가보자.

## 단일 서버
- 웹 앱, 데이터베이스, 캐시 등이 전부 서버 한 대로 구성된 시스템
- 단일 서버에서 시스템 흐름
  1. 사용자가 도메인 입력한 도메인 주소를 DNS에 질의한다.
  2. DNS가 IP주소를 반환한다.
  3. IP로 HTTP 요청을 전달한다.
  4. 요청을 받은 웹 서버는 HTML페이지나 JSON 형태로 응답을 반환한다.

## 데이터베이스
- 웹 서버와 데이터베이스 서버를 분리하면 그 각각을 독립적으로 확장시킬 수 있다.

- RDBMS - 관계형 데이터베이스
  - MySQL, 오라클 데이터베이스, PostgresSQL 등
  - 자료를 테이블과 열, 칼럽으로 표현
  - SQL을 사용해 데이터 관계에 따라 join 한다.

- NoSQL - 비 관계형 데이터베이스
  - Cassandra, HBase 등 
  - 키-값 저장소, 그래프 칼럼, 문서 형태로 저장할 수 있다.
  - 아주 낮은 응답 지연시간
  - 비정형 데이터
  - 데이터를 직렬화하거나 역직렬화 할 수 있다.
  - 대규모 데이터 저장에 유리하다.

### 데이터베이스 다중화
- Master(주)-Slave(부) 관계를 주로 사용한다.
- Master에서만 `쓰기 연산`을 지원한다.
- Slave는 주 DB로 부터 사본을 전달 받아 `읽기 연산`만을 지원한다.
- 대부분 읽기 연산의 비중이 쓰기 연산보다 높다. -> 부 데이터베이스 수를 더 많게 구성한다.
- 주-부 역할 분리로 병렬 처리할 수 있는 질의 수가 늘어난다. -> 성능 개선
- 다중화로 재해 상황에서도 데이터를 보존할 수 있다. -> 안정성
- 하나의 서버에 장애가 발생해도 다른 서버를 사용해 서비스를 할 수 있다. -> 가용성

## 수직적 규모확장 vs 수평적 규모 확장
- 수직적 규모확장 - `스케일 업`
  - 고사양 자원을 추가해 성능 개선
  - 트래픽이 적을 때 유리하다.
  - 규모 확장에 한계가 있다. -> 서버 한대에 메모리를 무한 증설할 수 없다.
  - 장애에 대한 자동복귀 방안이다 다중화 방안이 제시되지 않는다. -> 장애 발생시 완전 중단

- 수평적 규모 확장 - `스케일 아웃`
  - 서버를 추가해 성능 개선
  - 대규모 애플리케이션에 적절하다.
### 로드밸런서
- 부하 분산 집합에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할을 한다.
- 일부 서버에 장애가 발생하면 트래픽을 정상 서버로 전달해 웹 가용성을 향상할 수 있다.

## 캐시
- 응답 시간을 개선에 사용한다.
- 값 비싼 연산 결과나 자주 참조되는 데이터를 메모리에 저장해 요청이 빨리 처리될 수 있도록 한다.
- 캐시 계층
    - 데이터가 잠시 보관되는 곳으로 데이터베이스보다 빠르다.
    - 데이터베이스 부하를 줄일 수 있다.
    - 독립적 확장도 가능한다.
- 데이터 갱신은 자주 일어나지 않으며 참조가 빈번할 경우 사용한다.
- 영속적인 데이터의 보관은 바람직하지 못하다.
- 만료정책이 마련되어야 한다.
- 데이터 저장소의 원본과 `일관성`이 유지되어야 한다.
- 캐시 메모리를 과할당해 빈번한 갱신을 방지해야 한다.
- 데이터 방출 정책을 적절하게 적용해야 한다.
  - LRU - Least Recently Used
  - LFU - Last Frequently Used 
  - FIFO - First In First Out

## 콘텐츠 전송 네트워크(CDN)
- 응답 시간을 개선에 사용한다.
- 지리적으로 분산된 서버의 네트워크로 Image, Video, CSS, JavaScript 등을 캐시할 수 있다.
- 요청경로, 질의 문자열, 쿠키, 요청 헤더 등의 정보에 기반하여 HTML 페이지를 캐시한다.
- 가장 가까운 CDN 서버가 정적 콘텐츠를 전달해 로딩 시간을 개선한다.
- 자주 사용되는 콘텐츠를 캐싱해야한다.
- 적정한 만료 시한을 설정해야 한다. -> 너무 길면 컨텐츠 신선도가 떨어지고, 짧으면 원본 서버에 빈번하게 접속하게 된다.
- 오브젝트 버저닝을 통해 콘텐츠를 무효화 할 수 있다.

## 무상태 웹 계층
- 웹 계층이 상태정보를 갖고 있지 않을때
- 웹 계층이 상태정보를 보관한다면 같은 클라이언트의 요청을 같은 서버로 전달해야한다.
- 상태 정보를 웹 서버로부터 물리적으로 분리시킨다.
- 단순하고, 안정적이며, 규모 확장이 쉽다.
- 캐시 시스템이나, NoSql을 사용한다.

## 데이터 센터
- 데이터 센터를 분산 구성한다.
- 일반적인 상황의 경우 가까운 데이터 센터로 안내된다.
- 장애가 발생하면 장애가 발생하지 않은 데이터 센터로 트래픽이 전송된다.

## 메시지 큐
- 시스템 확장을 위해서는 컴포넌트를 분리하여 각기 독립적으로 확장될 수 있도록 해야한다. 메시지 큐는 분산 시스템의 문제해결 핵심 전략이다.
- 메시지의 무손실을 보장한다.
- 비동기 통신을 지원한다.
- 메시지의 버퍼 역할을 하며 비동기적으로 전송한다.
- 서비스 또는 서버 간 결합성을 낮춘다. -> 규모 확장 보장해야하는 안정적 애플리케이션 구성하기에 좋다.
- 생산자는 소비자 프로세스가 다운되어 있어도 메시지를 발핼 할 수 있고, 소비자는 생성자 서비스가 가용한 상태가 아니라도 메세지를 보낼 수 있다.
- 생상자와 소비자의 서비스가 독립적으로 확장 할 수 있다.


## 로그, 메트릭 그리고 자동화
- 로그 : 시스템 오류와 문제를 보다 쉽게 찾을 수 있다.
- 매트릭 : 시스템의 현재 상태를 손쉽게 파악할 수 있다.
  - 호스트 단위 메트릭 : CPU, 메모리, 디스크 I/O 등
  - 종합 메트릭 : 데이터베이스 계층의 성능, 캐시 계층의 성능 등
- 자동화 : 생산성을 높이기 위한 도구들

## 데이터베이스의 규모 확장
- 수직적 확장
  - 기존의 서버에 고성능 자원을 증설하는 방법
  - 무한 증설할 수 없다.
  - 단일 취약점으로 인한 위험이 크다
  - 비용이 많이 든다.

- 수평적 확장 - `샤딩`
  - 데이터베이스를 샤드라 부르는 작은 단위로 분할하는 기술
  - 모든 샤드는 같은 스키마르 쓰지만 데이터 사이의 중복은 없다.
  - 샤딩 키를 정할 떄는 데이터를 고르게 분할 할 수 있도록 해야한다.
  - 샤딩의 해결 과제
    - 데이터 재 샤딩 : 샤드를 변경해야할 경우 -> 안정해시로 해결가능 
    - 유명인사 문제 : 특정 샤드에 질의가 집중되는 경우
    - 조인과 비정규화 : 여러 샤드에 걸친 데이터 조인이 힘들어진다

## 정리
- 규모 확장을 위해 살펴본 기법
  - 웹 계층은 무상태 계층으로
  - 모든 계층에 다중화 도입
  - 가능한 한 많은 데이터를 캐시할 것
  - 여러 데이터 센터를 지원할 것
  - 정적 콘텐츠는 CDN을 통해 서비스할 것
  - 데이터 계층은 샤딩을 통해 그 규모를 확장할 것
  - 각 계층은 독리적 서비스로 분할할 것
  - 시스템을 지속적으로 모니터링하고, 자동화 도구를 활용할 것
