# 싱글톤 컨테이너
```
1. 웹 어플리케이션과 싱글톤
2. 싱글톤 패턴
3. 싱글톤 컨테이너
4. 싱글톤 방식의 주의점
5. @Configuration
```
---
## 1. 웹 어플리케이션과 싱글톤
- 스프링은 기업용 온라인 서비스 기술 지원을 위해 탄생함 => 동시에 여러 고객의 요청을 처리해야된다.
- 순수한 DI 컨테이너
    <img width="429" alt="순수" src="https://user-images.githubusercontent.com/20774279/152308565-5623e64c-3751-4d49-abf8-673646df3d44.png">
    - 순수한 DI 컨테이너의 경우 요청마다 객체를 생성해 메모리 낭비가 심하다. 
  
- 싱글턴 컨테이너
    <img width="415" alt="싱글톤" src="https://user-images.githubusercontent.com/20774279/152308556-0f343084-af64-48af-b9bb-d396c2ebdbf0.png">
  - 이미 만들어진 객체를 공유한다.
---
## 2. 싱글톤 패턴
- 클래스 인스턴스가 1개만 생성되는 것을 보장하는 디자인 패턴
- private 생성자 사용하여 외부에서 객체 생성하는 것을 막는다.
  
### 싱글톤 패턴의 문제점
- 구현 코드가 많이 들어간다.
- 의존관계상 클라이언트가 구체 클래스에 의존한다 -> DIP를 위반한다.
- 클라이언트가 구체 클래스에 의존해서 OCP원칙을 위반할 가능성이 높다.
- 테스트하기 어렵다.
- private 생성자로 자식 클래스를 만들기 어렵다.
- 유연성이 떨어진다.
- 안티패턴으로 불리기도 한다.
---
## 3. 싱글톤 컨테이너
- 스프링 컨테이너는 싱글톤 패턴의 문제점을 해결하며, 객체 인스턴스를 싱글턴으로 관리한다.
- 스프링 빈이 싱글톤으로 관리되는 빈이다.
- 스프링 컨테이너는 싱글턴 패턴을 적용하지 않아도, 객체 인스턴스를 싱글톤으로 관리한다.
- 컨테이너는 객체를 하나만 생성해서 관리한다.
- 스프링 컨테이너는 싱글톤 컨테이너 역학을 하며 싱글톤 객체를 생성, 관리하는 기능을 싱글톤 레지스트리라 한다.
- 스프링 객체는 싱글톤 패턴의 단점을 해결한다.
  - 싱글톤 패턴의 구현 코드가 들어가지 않는다.
  - DIP, OCP, 테스트, private 생성자로 부터 자유롭게 싱글톤 사용 가능하다.
---
## 4. 싱글톤 방식의 주의점
- 객체 인스턴스를 하나만 공유하기 때문에 상태를 유지하게 설계되면 안된다.
- 무상태로 설계해야한다.
  - 특정 클라이언트에 의존적인 필드가 있으면 안된다.
  - 특정 클라이언트가 값을 변경할 수 있는 필드가 있으면 안된다.
  - 가급적 읽기 기능만 가능해야 한다.
  - 필드 대신에 자바에서 공유되지 않는, 지역변수, 파라미터, ThreadLocal등을 사용해야 한다.
- 스프링 빈의 필드에 공유 값을 설정하면 큰 장애가 발생 할 수 있다. 
---
## 5. @Configuration
### @Configuration과 바이트 조작
```java
ApplicationContext ac = new AnnotationConfigApplicationContext(AppConfig.class);
```
```
bean = class hello.core.AppConfig$$EnhancerBySpringCGLIB$$bd71ad5d
```
- CGLIB라는 바이트코드 조작 라이브러리를 사용해서 상속받은 임의의 다른 클래스를 만들고, 그 다른 클래스를 스프링 빈으로 등록해서 사용한다. - 위의 경우는 AppConfig를 상속 받아서 생성된걸 확인 할 수 있다.
- `@Bean` 이 붙은 메서드마다 이미 스프링 빈이 존재하면 존재하는 빈을 반환하고, 없으면 생성해서 스프링 빈을 등록하고 반환한다. -> 덕분에 싱글톤이 보장된다.

### @Configuration가 적용하지 않고, @Bean만 적용하면?
- CGLIB 기술 없이 순수한 AppConfig로 스프링 빈이 등록된다.
- `@Bean`만 사용해도 스프링 빈으로 등록되지만, 싱글톤을 보장하지 않는다.
- 스프링 설정 정보는 항상 `@Configration`을 사용하자.